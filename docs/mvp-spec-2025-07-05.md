# MCP‚ÄìJCR Kotlin Server (MVP Spec with Readonly Mode)

**Stack:** Kotlin ‚Ä¢ Spring Boot ‚Ä¢ Gradle ‚Ä¢ MCP Java SDK (Spring AI starters) ‚Ä¢ Apache Jackrabbit ‚Ä¢ JCR API ‚Ä¢ Docker/macOS build

---

## üß∞ Project Setup

1. **Initialize**

   ```bash
   git init mcp-jcr-server && cd mcp-jcr-server
   ```

2. **Spring Initializr config**

   - Language: Kotlin
   - Dependencies: `spring-ai-starter-mcp-server-webflux`, `jackrabbit-core`, `jackrabbit-jcr2dav`, `spring-boot-starter-web`

3. **Gradle (**\`\`**) excerpt**

   ```kotlin
   plugins { kotlin("jvm") version "1.9.0"; id("org.springframework.boot") version "3.1.2" }

   dependencies {
     implementation("org.springframework.boot:spring-boot-starter-webflux")
     implementation("org.springframework.ai:spring-ai-starter-mcp-server-webflux:0.10.0")
     implementation("org.apache.jackrabbit:jackrabbit-core:2.21.4")
     implementation("org.apache.jackrabbit:jackrabbit-jcr2dav:2.21.4")
   }
   ```

   - Docker: Dockerfile running `gradle build` + `ENTRYPOINT ["java","-jar","app.jar"]`
   - macOS: run via `./gradlew bootRun`

---

## üèóÔ∏è Architecture Overview

```
Client (Claude, IDE agents, etc.) <--MCP JSON-RPC/SSE-->
‚¨á MCP Server (Spring WebFlux)
   ‚îú‚îÄ‚îÄ ToolRegistry (conditional tool registration based on readonly flag)
   ‚îú‚îÄ‚îÄ JcrService (manages JCR connections)
   ‚îú‚îÄ‚îÄ Tool implementations (use JcrService for JCR commands)
   ‚îî‚îÄ‚îÄ Docker/macOS entrypoints
```

- Server configuration (`application.yml`) with readonly toggle:
  ```yaml
  mcp:
    readonly: true
  ```

---

## üõ†Ô∏è Tool Implementations (with readonly check)

### Example with Readonly Check

```kotlin
@Component
class QueryTool(private val jcr: JcrService) : McpTool {
  override val name = "query"
  override val description = "Runs a JCR-SQL2 query and returns node paths"
  override suspend fun execute(params: JsonObject): JsonElement {
    if (jcr.isReadonly.not()) error("Server is in readonly mode")

    val q = params["query"]?.asString ?: error("query missing")
    jcr.sessionFactory.createSession().use { session ->
      val qr = session.workspace.queryManager.createQuery(q, Query.JCR_SQL2)
      return buildJsonArray {
        qr.execute().nodes.forEach { add(it.path) }
      }
    }
  }
}
```

### Tool registration conditional on readonly mode:

```kotlin
@Configuration
class ToolConfig(@Value("\${mcp.readonly}") val readonly: Boolean) {

  @Bean
  fun queryTool(jcr: JcrService) = QueryTool(jcr)

  @Bean
  @ConditionalOnProperty(name = ["mcp.readonly"], havingValue = "false")
  fun updateNodeTool(jcr: JcrService) = UpdateNodeTool(jcr)
}
```

---

## üß≠ Recommended Tools

**Readonly tools:**

- **query** ‚Äì run JCR-SQL2 queries
- **fetch** ‚Äì get node data by path
- **listChildren** ‚Äì list child node names
- **searchByFullText** ‚Äì JCR full-text search
- **exportTree** ‚Äì export subtree as JSON

**Write tools (disabled in readonly mode):**

- **updateNode** ‚Äì update node properties
- **deleteNode** ‚Äì delete nodes
- **createNode** ‚Äì create nodes with properties
- **runWorkflow** ‚Äì trigger JCR workflows/events

---

## üß™ Development & Deployment

- **Local/macOS**: `./gradlew bootRun`
- **Docker**: `java -jar app.jar` inside Docker container
- **Testing**: integration tests via `McpClient`, checking readonly flag enforcement

---

## ‚úÖ Next Steps

- Implement `JcrService` and `Repository` config
- Refine readonly mode UX/logging
- Add security layer (Basic Auth, etc.)
- Add end-to-end integration tests

