# MCP‚ÄìJCR Kotlin Server (Read-Only MVP Specification)

## Overview

This MCP server enables developers to interact with JCR repositories using AI agents. Developers can explore content structures, debug issues, and analyze data through natural language instead of writing JCR-SQL2 queries. Content architects and CMS administrators can reason about content organization and understand system structure without technical query languages. The initial release focuses on read-only operations for safe exploration.

**Stack:** Kotlin ‚Ä¢ Spring Boot ‚Ä¢ Gradle ‚Ä¢ MCP Java SDK (Spring AI starters) ‚Ä¢ Apache Jackrabbit ‚Ä¢ JCR API ‚Ä¢ Docker/macOS build

---

## üß∞ Project Setup

1. **Initialize**

   ```bash
   git init mcp-jcr-server && cd mcp-jcr-server
   ```

2. **Spring Initializr config**

   - Language: Kotlin
   - Dependencies: `spring-ai-starter-mcp-server-webflux`, `jackrabbit-core`, `jackrabbit-jcr2dav`, `spring-boot-starter-web`

3. **Gradle (**\`\`**) excerpt**

   ```kotlin
   plugins { kotlin("jvm") version "1.9.0"; id("org.springframework.boot") version "3.1.2" }

   dependencies {
     implementation("org.springframework.boot:spring-boot-starter-webflux")
     implementation("org.springframework.ai:spring-ai-starter-mcp-server-webflux:0.10.0")
     implementation("org.apache.jackrabbit:jackrabbit-core:2.21.4")
     implementation("org.apache.jackrabbit:jackrabbit-jcr2dav:2.21.4")
   }
   ```

   - Docker: Dockerfile running `gradle build` + `ENTRYPOINT ["java","-jar","app.jar"]`
   - macOS: run via `./gradlew bootRun`

---

## üèóÔ∏è Architecture Overview

```
Client (Claude, IDE agents, etc.) <--MCP JSON-RPC/SSE-->
‚¨á MCP Server (Spring WebFlux)
   ‚îú‚îÄ‚îÄ ToolRegistry (MVP: read-only tools only)
   ‚îú‚îÄ‚îÄ JcrService (manages JCR connections)
   ‚îú‚îÄ‚îÄ Tool implementations (use JcrService for JCR commands)
   ‚îî‚îÄ‚îÄ Docker/macOS entrypoints
```

**MVP Focus:** This initial release implements only read-only tools to ensure safe exploration and querying of JCR content. Write operations are documented below for future development phases.

---

## üõ†Ô∏è Tool Implementation

### Example Read-Only Tool Implementation

```kotlin
@Component
class QueryTool(private val jcr: JcrService) : McpTool {
  override val name = "query"
  override val description = "Runs a JCR-SQL2 query and returns node paths"
  override suspend fun execute(params: JsonObject): JsonElement {
    val q = params["query"]?.asString ?: error("query missing")
    jcr.sessionFactory.createSession().use { session ->
      val qr = session.workspace.queryManager.createQuery(q, Query.JCR_SQL2)
      return buildJsonArray {
        qr.execute().nodes.forEach { add(it.path) }
      }
    }
  }
}
```

### MVP Tool Registration (Read-Only)

```kotlin
@Configuration
class ToolConfig {
  @Bean
  fun queryTool(jcr: JcrService) = QueryTool(jcr)
  
  @Bean
  fun fetchTool(jcr: JcrService) = FetchTool(jcr)
  
  @Bean
  fun listChildrenTool(jcr: JcrService) = ListChildrenTool(jcr)
  
  // Write tools will be added in future releases
}
```

---

## üß≠ MCP Tools

### MVP Tools (Read-Only)

These tools are implemented in the initial release:

- **query** ‚Äì Execute JCR-SQL2 queries to find content
- **fetch** ‚Äì Retrieve node data and properties by path
- **listChildren** ‚Äì List child nodes of a given path
- **searchByFullText** ‚Äì Perform full-text searches across content
- **exportTree** ‚Äì Export an entire subtree as JSON for analysis

### Future Tools (Write Operations)

These tools are planned for future releases after the read-only MVP proves stable:

- **updateNode** ‚Äì Modify node properties
- **deleteNode** ‚Äì Remove nodes from the repository
- **createNode** ‚Äì Create new nodes with properties
- **runWorkflow** ‚Äì Trigger JCR workflows and processes

---

## üß™ Development & Deployment

- **Local/macOS**: `./gradlew bootRun`
- **Docker**: `java -jar app.jar` inside Docker container
- **Testing**: Integration tests via `McpClient` to verify:
  - Read-only tool functionality
  - Proper error handling
  - JCR session management
  - Query performance

---

## ‚úÖ Implementation Roadmap

### Phase 1: Read-Only MVP (Current)
- Implement `JcrService` and `Repository` configuration
- Build all read-only tools (query, fetch, listChildren, etc.)
- Add comprehensive error handling and logging
- Create integration tests for all read operations
- Document usage examples and best practices

### Phase 2: Security & Performance
- Add authentication layer (Basic Auth, OAuth)
- Implement query result pagination
- Add caching for frequently accessed nodes
- Performance benchmarking and optimization

### Phase 3: Write Operations (Future)
- Implement write tools with proper authorization
- Add transaction support and rollback capabilities
- Audit logging for all modifications
- Workflow integration support

